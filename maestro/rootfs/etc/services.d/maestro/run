#!/usr/bin/with-contenv bashio
# Start Hass Maestro Swift server with options from the add-on configuration.

ARGS=()

BASEURL=$(bashio::config 'baseurl')
if [ -n "$BASEURL" ]; then
    ARGS+=(--baseurl "$BASEURL")
fi

TOKEN=$(bashio::config 'token')
if [ -n "$TOKEN" ]; then
    ARGS+=(--token "$TOKEN")
fi

if bashio::config.true 'simulate'; then
    ARGS+=(--simulate)
fi

if bashio::config.true 'no_notify'; then
    ARGS+=(--no-notify)
fi

PROGRAM=$(bashio::config 'program')
if [ -n "$PROGRAM" ]; then
    ARGS+=(--program "$PROGRAM")
fi

if bashio::config.true 'verbose'; then
    ARGS+=(--verbose)
fi

echo "Debug: verifying maestro binary paths..." >&2
if [ -f /usr/src/app/.build/release/maestro ]; then
    echo "Found binary at /usr/src/app/.build/release/maestro" >&2
else
    echo "Binary missing at /usr/src/app/.build/release/maestro" >&2
    ls -al /usr/src/app/.build/release >&2 || true
fi

if [ -f /usr/bin/maestro ]; then
    echo "Found binary at /usr/bin/maestro" >&2
else
    echo "Binary missing at /usr/bin/maestro" >&2
    ls -al /usr/bin >&2 || true
fi

exec /usr/src/app/.build/release/maestro "${ARGS[@]}"
